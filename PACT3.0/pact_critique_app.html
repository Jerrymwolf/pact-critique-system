<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PACT 3.0 - Multi-Agent Academic Paper Critique System</title>
    <meta name="description" content="PACT 3.0: Advanced AI-powered academic paper critique using the PennCLO Academic Critique Taxonomy with specialized multi-agent analysis">

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <!-- Custom styling -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            font-family: 'Inter', sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .agent-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .agent-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .agent-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(102, 126, 234, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
            }
        }

        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        .score-ring {
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-bar {
            transition: width 0.3s ease;
        }

        /* Prevent infinite page expansion */
        #results-section {
            overflow-x: hidden;
        }

        /* Ensure chart container has proper constraints */
        .chart-container {
            max-width: 100%;
            overflow: hidden;
        }

        /* Custom styles for form elements to match Tailwind */
        .form-label {
            @apply block text-sm font-medium text-gray-700 mb-2;
        }
        .form-control {
            @apply w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500;
        }
        .form-select {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500;
        }
        .form-text {
            @apply mt-2 text-sm text-gray-500;
        }

        /* Additional styles for comprehensive interface */
        .main-tab-content {
            min-height: 200px;
        }

        .dim-tab-content {
            min-height: 300px;
        }

        .rotate-180 {
            transform: rotate(180deg);
        }

        /* Success/Warning/Error color classes */
        .text-success-green { color: #10b981; }
        .text-warning-orange { color: #f59e0b; }
        .text-critical-red { color: #ef4444; }
        .text-text-primary { color: #111827; }
        .text-text-secondary { color: #6b7280; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <div>
                        <h1 class="text-2xl font-bold">PACT 3.0</h1>
                        <p class="text-sm opacity-90">Multi-Agent Academic Paper Analysis</p>
                    </div>
                </div>
                <nav class="hidden md:flex space-x-6">
                    <button onclick="showScreen('upload')" class="hover:opacity-80 transition">Upload</button>
                    <button onclick="showScreen('analysis')" class="hover:opacity-80 transition">Analysis</button>
                    <button onclick="showScreen('about')" class="hover:opacity-80 transition">About</button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content Container -->
    <main class="container mx-auto px-6 py-8">

        <!-- Upload Screen -->
        <div id="upload-screen" class="screen">
            <div class="max-w-4xl mx-auto">
                <!-- Upload Card -->
                <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
                    <h2 class="text-3xl font-bold mb-4 gradient-text">Submit Your Paper for Critique</h2>
                    <p class="text-gray-600 mb-8">Upload your academic paper to receive comprehensive feedback from our specialized AI agents trained on the PACT taxonomy.</p>

                    <!-- File Upload Option -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Upload Paper File
                        </label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors">
                            <input 
                                type="file" 
                                id="file-upload" 
                                accept=".txt,.docx,.pdf"
                                class="hidden"
                                onchange="handleFileUpload(event)"
                            >
                            <div id="upload-area" class="cursor-pointer" 
                                 onclick="triggerFileUpload()"
                                 ondragover="handleDragOver(event)" 
                                 ondrop="handleDrop(event)" 
                                 ondragleave="handleDragLeave(event)">
                                <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <p class="text-gray-600">Click to upload or drag and drop</p>
                                <p class="text-sm text-gray-500">Supports: TXT, DOCX, PDF files</p>
                            </div>
                            <div id="file-info" class="hidden mt-4">
                                <p class="text-green-600 font-medium" id="file-name"></p>
                                <button onclick="clearFile()" class="mt-2 text-red-600 hover:text-red-800 text-sm">Remove file</button>
                            </div>
                        </div>
                    </div>

                    <!-- OR separator -->
                    <div class="mb-6 text-center">
                        <span class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm">OR</span>
                    </div>

                    <!-- Paper Content Input -->
                    <div class="mb-6">
                        <label for="paper-content" class="block text-sm font-medium text-gray-700 mb-2">
                            Paste Paper Content
                        </label>
                        <textarea 
                            id="paper-content" 
                            rows="12" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Or paste your paper content here..."
                            oninput="updateWordCount()"
                        ></textarea>
                        <div class="flex justify-between mt-2">
                            <span class="text-sm text-gray-500">
                                <span id="word-count">0</span> words
                            </span>
                            <span class="text-sm text-gray-500">Minimum 500 words recommended</span>
                        </div>
                    </div>

                    <!-- Paper Type Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Paper Type</label>
                        <select id="paper-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="research">Research Article</option>
                            <option value="thesis">Thesis/Dissertation</option>
                            <option value="review">Literature Review</option>
                            <option value="essay">Academic Essay</option>
                            <option value="proposal">Research Proposal</option>
                        </select>
                    </div>

                    <!-- Analysis Mode Selection -->
                    <div class="mb-6">
                        <label for="analysisMode" class="form-label">Analysis Mode</label>
                        <select class="form-select" id="analysisMode">
                            <option value="STANDARD" selected>Standard - Auto-select relevant PACT elements</option>
                            <option value="COMPREHENSIVE">Comprehensive - Analyze all PACT elements thoroughly</option>
                            <option value="APA7">APA7 - Focus only on APA Style compliance</option>
                        </select>
                        <div class="form-text">
                            <small>
                                <strong>Standard:</strong> Analyzes most relevant sections based on your paper's content<br>
                                <strong>Comprehensive:</strong> Systematic analysis of all PACT dimensions<br>
                                <strong>APA7:</strong> Focused analysis of APA Style formatting and citations only
                            </small>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button id="analyze-btn" onclick="startAnalysis()" class="w-full gradient-bg text-white font-semibold py-4 px-6 rounded-lg hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                            Start PACT Analysis
                        </span>
                    </button>
                </div>

                <!-- PACT Dimensions Info -->
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h3 class="text-2xl font-bold mb-6 gradient-text">What We Analyze</h3>
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="p-4 border border-gray-200 rounded-lg hover:shadow-md transition">
                            <div class="flex items-center mb-2">
                                <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                                    <span class="text-purple-600 font-bold">1</span>
                                </div>
                                <h4 class="font-semibold">Research Foundations</h4>
                            </div>
                            <p class="text-sm text-gray-600">Problem definition, theoretical framework, literature synthesis</p>
                        </div>

                        <div class="p-4 border border-gray-200 rounded-lg hover:shadow-md transition">
                            <div class="flex items-center mb-2">
                                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                    <span class="text-blue-600 font-bold">2</span>
                                </div>
                                <h4 class="font-semibold">Methodological Rigor</h4>
                            </div>
                            <p class="text-sm text-gray-600">Methods alignment, data quality, analysis validity</p>
                        </div>

                        <div class="p-4 border border-gray-200 rounded-lg hover:shadow-md transition">
                            <div class="flex items-center mb-2">
                                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                                    <span class="text-green-600 font-bold">3</span>
                                </div>
                                <h4 class="font-semibold">Structure & Coherence</h4>
                            </div>
                            <p class="text-sm text-gray-600">Organization, flow, transitions, logical progression</p>
                        </div>

                        <div class="p-4 border border-gray-200 rounded-lg hover:shadow-md transition">
                            <div class="flex items-center mb-2">
                                <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center mr-3">
                                    <span class="text-yellow-600 font-bold">4</span>
                                </div>
                                <h4 class="font-semibold">Academic Precision</h4>
                            </div>
                            <p class="text-sm text-gray-600">Citations, terminology, grammar, formatting</p>
                        </div>

                        <div class="p-4 border border-gray-200 rounded-lg hover:shadow-md transition">
                            <div class="flex items-center mb-2">
                                <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center mr-3">
                                    <span class="text-red-600 font-bold">5</span>
                                </div>
                                <h4 class="font-semibold">Critical Sophistication</h4>
                            </div>
                            <p class="text-sm text-gray-600">Reflexivity, originality, theoretical depth</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Screen -->
        <div id="analysis-screen" class="screen hidden">
            <!-- Progress Section -->
            <div id="progress-section" class="max-w-6xl mx-auto mb-8">
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold mb-6">Analysis in Progress</h2>

                    <!-- Overall Progress -->
                    <div class="mb-8">
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700">Overall Progress</span>
                            <span id="progress-text" class="text-sm font-medium text-purple-600">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div id="progress-bar" class="gradient-bg h-3 rounded-full progress-bar" style="width: 0%"></div>
                        </div>
                        <div id="status-message" class="mt-3 text-center text-sm text-gray-600">Waiting to start...</div>
                    </div>

                    <!-- Agent Status Grid -->
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Supervisor Agent -->
                        <div id="agent-supervisor" class="agent-card p-4 bg-gray-50 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mr-2">
                                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                        </svg>
                                    </div>
                                    <span class="font-semibold text-sm">Supervisor</span>
                                </div>
                                <span class="agent-status text-xs text-gray-500">Waiting</span>
                            </div>
                            <div class="agent-message text-xs text-gray-600 hidden">
                                <div class="typing-indicator">
                                    <span class="typing-dot"></span>
                                    <span class="typing-dot"></span>
                                    <span class="typing-dot"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Agent 1: Research Foundations -->
                        <div id="agent-1" class="agent-card p-4 bg-gray-50 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mr-2">
                                        <span class="text-purple-600 font-bold text-xs">1</span>
                                    </div>
                                    <span class="font-semibold text-sm">Research Found.</span>
                                </div>
                                <span class="agent-status text-xs text-gray-500">Waiting</span>
                            </div>
                            <div class="agent-message text-xs text-gray-600 hidden"></div>
                        </div>

                        <!-- Agent 2: Methodological Rigor -->
                        <div id="agent-2" class="agent-card p-4 bg-gray-50 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-2">
                                        <span class="text-blue-600 font-bold text-xs">2</span>
                                    </div>
                                    <span class="font-semibold text-sm">Method. Rigor</span>
                                </div>
                                <span class="agent-status text-xs text-gray-500">Waiting</span>
                            </div>
                            <div class="agent-message text-xs text-gray-600 hidden"></div>
                        </div>

                        <!-- Agent 3: Structure & Coherence -->
                        <div id="agent-3" class="agent-card p-4 bg-gray-50 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-2">
                                        <span class="text-green-600 font-bold text-xs">3</span>
                                    </div>
                                    <span class="font-semibold text-sm">Structure</span>
                                </div>
                                <span class="agent-status text-xs text-gray-500">Waiting</span>
                            </div>
                            <div class="agent-message text-xs text-gray-600 hidden"></div>
                        </div>

                        <!-- Agent 4: Academic Precision -->
                        <div id="agent-4" class="agent-card p-4 bg-gray-50 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center mr-2">
                                        <span class="text-yellow-600 font-bold text-xs">4</span>
                                    </div>
                                    <span class="font-semibold text-sm">Precision</span>
                                </div>
                                <span class="agent-status text-xs text-gray-500">Waiting</span>
                            </div>
                            <div class="agent-message text-xs text-gray-600 hidden"></div>
                        </div>

                        <!-- Agent 5: Critical Sophistication -->
                        <div id="agent-5" class="agent-card p-4 bg-gray-50 rounded-lg">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center mr-2">
                                        <span class="text-red-600 font-bold text-xs">5</span>
                                    </div>
                                    <span class="font-semibold text-sm">Sophistication</span>
                                </div>
                                <span class="agent-status text-xs text-gray-500">Waiting</span>
                            </div>
                            <div class="agent-message text-xs text-gray-600 hidden"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Section (Initially Hidden) -->
            <div id="results-section" class="hidden max-w-6xl mx-auto">
                <!-- Main Results Card -->
                <div class="bg-white rounded-xl shadow-lg">
                    <div class="p-8">
                        <!-- Header with Export Actions -->
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                Analysis Results
                            </h2>
                            <div class="flex space-x-2">
                                <button onclick="toggleDownloadMenu()" class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    Export PDF
                                </button>
                                <button onclick="shareResults()" class="inline-flex items-center px-3 py-2 border border-transparent rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm9.316 0a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                                    </svg>
                                    Share
                                </button>
                            </div>
                        </div>

                        <!-- Learning Resources Banner -->
                        <div class="mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-start space-x-3">
                                <svg class="h-5 w-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                </svg>
                                <div class="flex-1">
                                    <h3 class="text-sm font-semibold text-blue-800 mb-1">
                                        Improve Your Academic Writing Skills
                                    </h3>
                                    <p class="text-xs text-blue-700 mb-2">
                                        Each element in your analysis links to detailed explanations, examples, and improvement strategies in our PACT Wiki.
                                    </p>
                                    <div class="flex items-center space-x-3">
                                        <button onclick="window.open('/pact-wiki', '_blank')" class="inline-flex items-center px-2 py-1 text-xs border border-blue-300 rounded text-blue-600 hover:bg-blue-600 hover:text-white transition-colors">
                                            <svg class="mr-1 h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                            </svg>
                                            Explore PACT Wiki
                                        </button>
                                        <span class="text-xs text-blue-600">
                                            Click "Learn More" buttons below for targeted help
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- PACT Spider Chart Visualization -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                PACT Dimensions Overview
                            </h3>
                            <div class="chart-container flex justify-center">
                                <canvas id="dimension-chart" style="max-width: 400px; max-height: 400px;"></canvas>
                            </div>
                        </div>

                        <!-- Overall Score and Dimension Scores Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <!-- Overall Score with Circular Progress -->
                            <div class="text-center">
                                <div class="relative mx-auto mb-4" style="width: 128px; height: 128px;">
                                    <svg class="w-32 h-32 transform -rotate-90">
                                        <circle cx="64" cy="64" r="56" stroke="#e5e7eb" stroke-width="8" fill="none"></circle>
                                        <circle id="score-circle" cx="64" cy="64" r="56" stroke="url(#gradient)" stroke-width="8" fill="none" 
                                                stroke-dasharray="351.86" stroke-dashoffset="351.86" class="transition-all duration-1000 ease-out"></circle>
                                        <defs>
                                            <linearGradient id="gradient">
                                                <stop offset="0%" stop-color="#10b981"/>
                                                <stop offset="50%" stop-color="#3b82f6"/>
                                                <stop offset="100%" stop-color="#8b5cf6"/>
                                            </linearGradient>
                                        </defs>
                                    </svg>
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <div class="text-center">
                                            <span id="overall-score" class="text-2xl font-bold text-gray-900">0.0</span>
                                            <span class="text-gray-500 text-sm block">/ 5.0</span>
                                        </div>
                                    </div>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-900">Overall Assessment</h3>
                            </div>

                            <!-- Dimension Scores -->
                            <div class="space-y-3">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Dimension Scores</h3>
                                <div id="dimension-scores-list" class="space-y-3">
                                    <!-- Dimension scores will be populated here -->
                                </div>
                            </div>
                        </div>

                        <!-- Document Context Information -->
                        <div id="document-context" class="hidden mb-6">
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-semibold text-purple-800 flex items-center">
                                        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        Document Context
                                    </h4>
                                    <span id="document-type" class="text-sm font-medium text-purple-600">
                                        <!-- Document type will be populated here -->
                                    </span>
                                </div>

                                <div id="document-context-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                                    <!-- Context information will be populated here -->
                                </div>
                            </div>
                        </div>

                        <!-- Analysis Coverage Metadata -->
                        <div id="analysis-metadata" class="hidden mb-8">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-semibold text-blue-800 flex items-center">
                                        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        Document Analysis Coverage
                                    </h4>
                                    <div id="coverage-percentage" class="text-sm text-blue-600">
                                        <!-- Coverage percentage will be populated here -->
                                    </div>
                                </div>

                                <div id="analysis-metadata-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                    <!-- Metadata will be populated here -->
                                </div>
                            </div>
                        </div>

                        <!-- Key Findings Summary Cards -->
                        <div class="mb-8">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <!-- Critical Issues Card -->
                                <div class="p-4 bg-red-50 rounded-lg border border-red-200">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <div class="w-2 h-2 bg-red-600 rounded-full"></div>
                                        <h4 class="font-semibold text-red-600">Critical Issues</h4>
                                    </div>
                                    <p id="critical-count" class="text-2xl font-bold text-red-600 mb-1">0</p>
                                    <p class="text-xs text-gray-600">Require immediate attention</p>
                                </div>

                                <!-- Areas for Improvement Card -->
                                <div class="p-4 bg-orange-50 rounded-lg border border-orange-200">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <div class="w-2 h-2 bg-orange-500 rounded-full"></div>
                                        <h4 class="font-semibold text-orange-600">Areas for Improvement</h4>
                                    </div>
                                    <p id="improvement-count" class="text-2xl font-bold text-orange-600 mb-1">0</p>
                                    <p class="text-xs text-gray-600">Should be addressed</p>
                                </div>

                                <!-- Strengths Card -->
                                <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <div class="w-2 h-2 bg-green-600 rounded-full"></div>
                                        <h4 class="font-semibold text-green-600">Strengths</h4>
                                    </div>
                                    <p id="strength-count" class="text-2xl font-bold text-green-600 mb-1">0</p>
                                    <p class="text-xs text-gray-600">Well-executed elements</p>
                                </div>
                            </div>

                            <!-- Detailed Findings Dropdown -->
                            <div class="border border-gray-200 rounded-lg">
                                <button onclick="toggleDetailedFindings()" class="w-full flex items-center justify-between p-4 font-medium text-left hover:bg-gray-50 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <span class="flex items-center">
                                        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        View Detailed Findings Checklist
                                    </span>
                                    <svg id="findings-chevron" class="h-4 w-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>

                                <div id="detailed-findings" class="hidden border-t border-gray-200 p-4 bg-gray-50">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <!-- Critical Issues Checklist -->
                                        <div>
                                            <h4 class="font-semibold text-red-600 mb-3 flex items-center">
                                                <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                                </svg>
                                                Critical Issues (<span id="critical-issues-count">0</span>)
                                            </h4>
                                            <div id="critical-issues-list" class="space-y-2 max-h-60 overflow-y-auto">
                                                <!-- Critical issues will be populated here -->
                                            </div>
                                        </div>

                                        <!-- Areas for Improvement Checklist -->
                                        <div>
                                            <h4 class="font-semibold text-orange-600 mb-3 flex items-center">
                                                <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                                </svg>
                                                Areas for Improvement (<span id="improvement-issues-count">0</span>)
                                            </h4>
                                            <div id="improvement-issues-list" class="space-y-2 max-h-60 overflow-y-auto">
                                                <!-- Improvement issues will be populated here -->
                                            </div>
                                        </div>

                                        <!-- Strengths Checklist -->
                                        <div>
                                            <h4 class="font-semibold text-green-600 mb-3 flex items-center">
                                                <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                                Strengths (<span id="strength-elements-count">0</span>)
                                            </h4>
                                            <div id="strength-elements-list" class="space-y-2 max-h-60 overflow-y-auto">
                                                <!-- Strength elements will be populated here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Main Content Tabs -->
                        <div class="border-t border-gray-200 pt-6">
                            <!-- Tab Navigation -->
                            <div class="border-b border-gray-200 mb-6">
                                <nav id="main-tabs-nav" class="-mb-px flex space-x-8">
                                    <button onclick="showMainTab('summary')" id="main-tab-summary" class="main-tab-btn py-2 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600">
                                        <svg class="inline w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        Summary Analysis
                                    </button>
                                    <button onclick="showMainTab('details')" id="main-tab-details" class="main-tab-btn py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                                        <svg class="inline w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                        PACT Details
                                    </button>
                                    <button onclick="showMainTab('custom')" id="main-tab-custom" class="main-tab-btn py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 hidden">
                                        <svg class="inline w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        Custom Analysis
                                    </button>
                                </nav>
                            </div>

                            <!-- Tab Content -->
                            <div id="main-tab-content-summary" class="main-tab-content">
                                <div id="summary-analysis-content" class="text-center py-8 text-gray-500">
                                    <p>Summary analysis is being generated...</p>
                                    <p class="text-sm mt-1">This will be available shortly after the detailed analysis completes.</p>
                                </div>
                            </div>

                            <div id="main-tab-content-details" class="main-tab-content hidden">
                                <!-- Dimension Sub-tabs -->
                                <div class="border-b border-gray-200 mb-6">
                                    <nav id="dimension-tabs" class="-mb-px flex space-x-8">
                                        <!-- Dimension tabs will be populated here -->
                                    </nav>
                                </div>

                                <!-- Dimension Tab Content -->
                                <div id="dimension-tab-content">
                                    <!-- Selected dimension content will be populated here -->
                                </div>
                            </div>

                            <div id="main-tab-content-custom" class="main-tab-content hidden">
                                <div id="custom-analysis-content">
                                    <!-- Custom analysis content will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="border-t border-gray-200 p-6">
                        <div class="flex flex-col sm:flex-row gap-4">
                            <!-- Download Dropdown -->
                            <div class="relative flex-1">
                                <!-- Download Menu -->
                                <div id="download-menu" class="hidden absolute bottom-full left-0 right-0 mb-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10">
                                    <button onclick="downloadReport('pdf')" class="w-full px-4 py-3 text-left hover:bg-gray-50 flex items-center">
                                        <svg class="w-4 h-4 mr-3 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                        </svg>
                                        Executive Summary
                                        <span class="ml-auto text-xs text-gray-500">(Summary + checklist)</span>
                                    </button>
                                    <button onclick="downloadReport('comprehensive')" class="w-full px-4 py-3 text-left hover:bg-gray-50 flex items-center border-t border-gray-100">
                                        <svg class="w-4 h-4 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                        Comprehensive Report
                                        <span class="ml-auto text-xs text-gray-500">(Full details + checklist)</span>
                                    </button>
                                    <button onclick="downloadReport('checklist')" class="w-full px-4 py-3 text-left hover:bg-gray-50 flex items-center border-t border-gray-100">
                                        <svg class="w-4 h-4 mr-3 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        Checklist Only
                                        <span class="ml-auto text-xs text-gray-500">(Print & track revisions)</span>
                                    </button>
                                </div>
                            </div>

                            <button onclick="startNewAnalysis()" class="flex-1 gradient-bg text-white font-semibold py-3 px-6 rounded-lg hover:opacity-90 transition">
                                <span class="flex items-center justify-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    Analyze Another Paper
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- About Screen -->
        <div id="about-screen" class="screen hidden">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-3xl font-bold mb-6 gradient-text">About PACT 3.0</h2>

                    <div class="prose max-w-none">
                        <p class="text-lg text-gray-700 mb-6">
                            The PACT (PennCLO Academic Critique Taxonomy) system provides comprehensive, multi-dimensional analysis of academic papers using specialized AI agents trained on rigorous scholarly standards.
                        </p>

                        <h3 class="text-xl font-semibold mt-8 mb-4">How It Works</h3>
                        <ol class="list-decimal list-inside space-y-3 text-gray-700">
                            <li><strong>Submit Your Paper:</strong> Upload or paste your academic work</li>
                            <li><strong>Supervisor Planning:</strong> Our supervisor agent analyzes your paper and creates a critique plan</li>
                            <li><strong>Parallel Analysis:</strong> Five specialized agents evaluate different dimensions simultaneously</li>
                            <li><strong>Synthesis:</strong> The supervisor combines all feedback into a cohesive report</li>
                            <li><strong>Actionable Feedback:</strong> Receive specific recommendations for improvement</li>
                        </ol>

                        <h3 class="text-xl font-semibold mt-8 mb-4">The Five PACT Dimensions</h3>
                        <div class="space-y-4">
                            <div class="p-4 bg-purple-50 rounded-lg">
                                <h4 class="font-semibold text-purple-900">1. Research Foundations</h4>
                                <p class="text-purple-700">Problem identification, theoretical frameworks, literature synthesis, and argument construction</p>
                            </div>
                            <div class="p-4 bg-blue-50 rounded-lg">
                                <h4 class="font-semibold text-blue-900">2. Methodological Rigor</h4>
                                <p class="text-blue-700">Method-question alignment, data quality, analysis validity, and limitations recognition</p>
                            </div>
                            <div class="p-4 bg-green-50 rounded-lg">
                                <h4 class="font-semibold text-green-900">3. Structure & Coherence</h4>
                                <p class="text-green-700">Organization, flow, transitions, and logical progression</p>
                            </div>
                            <div class="p-4 bg-yellow-50 rounded-lg">
                                <h4 class="font-semibold text-yellow-900">4. Academic Precision</h4>
                                <p class="text-yellow-700">Term consistency, citation accuracy, grammar, and formatting standards</p>
                            </div>
                            <div class="p-4 bg-red-50 rounded-lg">
                                <h4 class="font-semibold text-red-900">5. Critical Sophistication</h4>
                                <p class="text-red-700">Reflexivity, originality, theoretical engagement, and scholarly maturity</p>
                            </div>
                        </div>

                        <h3 class="text-xl font-semibold mt-8 mb-4">Privacy & Security</h3>
                        <p class="text-gray-700">
                            Your papers are processed securely and are not stored after analysis. All evaluations are performed in real-time and results are only accessible to you.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-16">
        <div class="container mx-auto px-6 py-8">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <p class="text-sm">© 2024 PACT 3.0. Built with LangGraph & Multi-Agent AI</p>
                </div>
                <div class="flex space-x-6">
                    <a href="#" class="text-sm hover:text-purple-400 transition">Documentation</a>
                    <a href="#" class="text-sm hover:text-purple-400 transition">GitHub</a>
                    <a href="#" class="text-sm hover:text-purple-400 transition">Contact</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        // Global variables
        let currentScreen = 'upload';
        let analysisData = null;
        let dimensionChart = null;
        let currentSessionId = null;
        let websocket = null;
        let currentResult = null; // To store the final result payload

        // Polling variables
        let usePolling = false;      // turn on only if WS closes
        let pollAbort = null;
        let currentPollTimeout = null; // For polling specific functions

        // Configure API base URL
        const API_BASE_URL = window.location.protocol + '//' + window.location.host;

        // ===== UTILITY FUNCTIONS =====

        // SVG Path validation and corruption detection
        function validateSVGPaths() {
            const SAFE_D_PATTERN = /^[MLHVCSQTAZmlhvcsqtaz0-9.,\s-]+$/;

            for (const pathEl of document.querySelectorAll('path[d]')) {
                const d = pathEl.getAttribute('d') || '';
                if (!SAFE_D_PATTERN.test(d)) {
                    console.warn('Corrupted SVG path detected:', pathEl, d);
                    // Remove corrupted path to prevent parsing errors
                    pathEl.remove();
                }
                if (d.includes('Scientology') || /[A-Za-z]{3,}/.test(d.replace(/[MLHVCSQTAZmlhvcsqtaz]/g, ''))) {
                    console.error('SVG path contains unexpected text:', pathEl, d);
                    pathEl.remove();
                }
            }
        }

        // Safe SVG creation helper
        function createSVGIcon(pathData, className = 'w-4 h-4') {
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('class', className);
            svg.setAttribute('fill', 'none');
            svg.setAttribute('stroke', 'currentColor');
            svg.setAttribute('viewBox', '0 0 24 24');

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('stroke-linecap', 'round');
            path.setAttribute('stroke-linejoin', 'round');
            path.setAttribute('stroke-width', '2');
            path.setAttribute('d', pathData);

            svg.appendChild(path);
            return svg;
        }

        // Safe innerHTML wrapper that preserves SVG integrity
        function safeSetInnerHTML(element, htmlContent) {
            // Check if element contains SVG elements
            const hasSVG = element.querySelector('svg');

            if (hasSVG) {
                console.warn('Attempting to set innerHTML on element containing SVG - this may corrupt paths');
                // Save SVG elements before setting innerHTML
                const svgElements = Array.from(element.querySelectorAll('svg')).map(svg => svg.cloneNode(true));
                element.innerHTML = htmlContent;
                // Restore SVG elements if they were lost
                if (!element.querySelector('svg') && svgElements.length > 0) {
                    svgElements.forEach(svg => element.appendChild(svg));
                }
            } else {
                element.innerHTML = htmlContent;
            }
        }

        function showError(message) {
            alert(`Analysis Error: ${message}`);
            showScreen('upload');
        }

        // Update the progress bar and percentage
        function updateProgress(percent) {
            document.getElementById('progress-text').textContent = `${Math.round(percent)}%`;
            document.getElementById('progress-bar').style.width = `${percent}%`;
        }

        // Helper function for delays
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Show the results section and hide the progress section
        function showResults() {
            document.getElementById('progress-section').classList.add('hidden');
            document.getElementById('results-section').classList.remove('hidden');
        }

        // Display the analysis results in the UI
        function displayResults(data) {
            console.log('Displaying results with data:', data);

            // Hide score UI when in qualitative mode
            if (data.qualitativeMode) {
                // Hide overall score section
                const overallScoreContainer = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-2.gap-6.mb-8');
                if (overallScoreContainer) {
                    overallScoreContainer.classList.add('hidden');
                }
            } else {
                const score = data.overallScore || 75;

                // Convert score to 0-5 scale if it's 0-100
                const normalizedScore = score > 5 ? score / 20 : score;
                document.getElementById('overall-score').textContent = normalizedScore.toFixed(1);

                // Animate the score circle (assuming 0-5 scale)
                const circle = document.getElementById('score-circle');
                const circumference = 351.86;
                const percentage = (normalizedScore / 5) * 100;
                setTimeout(() => {
                    circle.style.strokeDashoffset = circumference - (percentage / 100) * circumference;
                    circle.style.transition = 'stroke-dashoffset 1s ease-in-out';
                }, 100);

                // Populate dimension scores for quantitative mode
                populateDimensionScores(data.dimensions || getDefaultDimensions());
            }

            // Show document context if available
            populateDocumentContext(data);

            // Show analysis metadata
            populateAnalysisMetadata(data);

            // Populate key findings cards
            populateKeyFindingsCards(data);

            // Populate detailed findings checklist
            populateDetailedFindings(data);

            // Populate main tab content
            populateMainTabContent(data);

            // Show success message
            showNotification('Analysis completed successfully! Review your comprehensive results below.', 'success');
        }

        // Display detailed analysis for each dimension
        function displayDetailedDimensions(dimensionAnalyses) {
            const container = document.getElementById('dimensions-detail');

            if (Object.keys(dimensionAnalyses).length === 0) {
                container.innerHTML = '<p class="text-gray-500">Detailed dimension analysis will be available after enhanced critique completion.</p>';
                return;
            }

            container.innerHTML = Object.entries(dimensionAnalyses).map(([dimId, dimension]) => `
                <div class="border-l-4 border-purple-500 pl-6 py-4">
                    <div class="mb-4">
                        <h5 class="text-xl font-bold text-gray-900 mb-2">${dimension.dimension_name.toUpperCase()}</h5>
                        <div class="flex items-center mb-3">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${
                                dimension.overall_assessment === 'Strong' ? 'bg-green-100 text-green-800' :
                                dimension.overall_assessment === 'Developing' ? 'bg-yellow-100 text-yellow-800' :
                                'bg-red-100 text-red-800'
                            }">${dimension.overall_assessment}</span>
                        </div>
                        <p class="text-gray-700 mb-4">${dimension.executive_summary}</p>
                    </div>

                    ${dimension.subsections ? Object.entries(dimension.subsections).map(([code, subsection]) => `
                        <div class="mb-4 pl-4 border-l-2 border-gray-200">
                            <h6 class="font-semibold text-gray-900 mb-2">${code}: ${subsection.name}</h6>
                            <div class="mb-2">
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium ${
                                    subsection.assessment === 'Strong' ? 'bg-green-100 text-green-700' :
                                    subsection.assessment === 'Developing' ? 'bg-yellow-100 text-yellow-700' :
                                    'bg-red-100 text-red-700'
                                }">${subsection.assessment}</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">${subsection.detailed_feedback}</p>

                            ${subsection.strengths && subsection.strengths.length > 0 ? `
                                <div class="mb-2">
                                    <span class="text-xs font-medium text-green-700">Strengths:</span>
                                    <ul class="list-disc list-inside text-xs text-gray-600 ml-2">
                                        ${subsection.strengths.map(s => `<li>${s}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}

                            ${subsection.areas_for_improvement && subsection.areas_for_improvement.length > 0 ? `
                                <div class="mb-2">
                                    <span class="text-xs font-medium text-orange-700">Areas for Improvement:</span>
                                    <ul class="list-disc list-inside text-xs text-gray-600 ml-2">
                                        ${subsection.areas_for_improvement.map(i => `<li>${i}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `).join('') : ''}

                    ${dimension.key_strengths && dimension.key_strengths.length > 0 ? `
                        <div class="mt-4">
                            <h6 class="font-semibold text-green-700 mb-2">Key Dimension Strengths:</h6>
                            <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
                                ${dimension.key_strengths.map(s => `<li>${s.strength} - ${s.evidence}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    ${dimension.priority_improvements && dimension.priority_improvements.length > 0 ? `
                        <div class="mt-4">
                            <h6 class="font-semibold text-orange-700 mb-2">Priority Improvements:</h6>
                            <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
                                ${dimension.priority_improvements.map(i => `<li>${i.area} - ${i.recommendation}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Display items for the PACT checklist
        function displayPACTChecklist(checklistItems) {
            const improvementContainer = document.getElementById('improvement-checklist');
            const strengthContainer = document.getElementById('strength-checklist');

            if (checklistItems.length === 0) {
                improvementContainer.innerHTML = '<p class="text-gray-500">Checklist items will be available after enhanced critique completion.</p>';
                strengthContainer.innerHTML = '<p class="text-gray-500">Strengths checklist will be available after enhanced critique completion.</p>';
                return;
            }

            const improvements = checklistItems.filter(item => !item.completed);
            const strengths = checklistItems.filter(item => item.completed);

            improvementContainer.innerHTML = improvements.map(item => `
                <div class="flex items-start p-3 bg-orange-50 rounded-lg border border-orange-200">
                    <input type="checkbox" class="mt-1 mr-3 text-orange-600" ${item.completed ? 'checked' : ''}>
                    <div class="flex-1">
                        <div class="flex items-center mb-1">
                            <span class="font-semibold text-orange-800 text-sm mr-2">${item.code}</span>
                            <span class="font-medium text-gray-900 text-sm">${item.name}</span>
                        </div>
                        <p class="text-sm text-gray-700">${item.description}</p>
                    </div>
                </div>
            `).join('');

            strengthContainer.innerHTML = strengths.map(item => `
                <div class="flex items-start p-3 bg-green-50 rounded-lg border border-green-200">
                    <svg class="w-5 h-5 text-green-500 mr-3 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <div class="flex-1">
                        <div class="flex items-center mb-1">
                            <span class="font-semibold text-orange-800 text-sm mr-2">${item.code}</span>
                            <span class="font-medium text-gray-900 text-sm">${item.name}</span>
                        </div>
                        <p class="text-sm text-gray-700">${item.description}</p>
                    </div>
                </div>
            `).join('');
        }

        // Create and render the dimension scores chart
        function createDimensionChart(dimensions) {
            const ctx = document.getElementById('dimension-chart').getContext('2d');

            if (dimensionChart) {
                dimensionChart.destroy(); // Destroy previous chart instance if exists
            }

            dimensionChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: Object.keys(dimensions),
                    datasets: [{
                        label: 'Score',
                        data: Object.values(dimensions),
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(102, 126, 234, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.5, // Adjust aspect ratio for better visualization
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20 // Show ticks every 20 points
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false // Hide legend as it's not necessary for radar chart
                        }
                    }
                }
            });
        }

        // Handle tab switching logic
        function showTab(tabName) {
            // Hide all tab content panes
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });

            // Reset all tab button styles
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-purple-500', 'text-purple-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });

            // Show the selected tab content
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');

            // Highlight the selected tab button
            event.target.classList.remove('border-transparent', 'text-gray-500');
            event.target.classList.add('border-purple-500', 'text-purple-600');
        }

        // Toggle the visibility of the download report menu
        function toggleDownloadMenu() {
            const menu = document.getElementById('download-menu');
            menu.classList.toggle('hidden');
        }

        // Close the download menu if the user clicks outside of it
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('download-menu');
            const button = event.target.closest('button[onclick="toggleDownloadMenu()"]');

            if (!button && !menu.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });

        // Handle report download request
        async function downloadReport(format = 'comprehensive') {
            if (!currentSessionId) {
                alert('No analysis session available for download.');
                return;
            }

            try {
                // Hide the dropdown menu
                document.getElementById('download-menu').classList.add('hidden');

                // Get the specific button that was clicked and store its original state
                const btn = event.currentTarget;
                const original = btn.innerHTML;
                btn.dataset.original = original;
                btn.disabled = true;

                // Clear button and safely add SVG icon
                btn.innerHTML = '';

                // Create SVG element safely
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('class', 'w-4 h-4 mr-3 animate-spin');
                svg.setAttribute('fill', 'none');
                svg.setAttribute('stroke', 'currentColor');
                svg.setAttribute('viewBox', '0 0 24 24');

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('stroke-linecap', 'round');
                path.setAttribute('stroke-linejoin', 'round');
                path.setAttribute('stroke-width', '2');
                path.setAttribute('d', 'M4 4v5h.582m15.356 2A8.955 8.955 0 0 1 21 12c0 .778-.099 1.533-.284 2.262M3 12c0-.778.099-1.533.284-2.262m0 0A8.955 8.955 0 0 1 12 3c2.777 0 5.288 1.089 7.184 2.816M3 12v5.341m9-9.341c0 2.21-.766 4.239-2.05 5.658m9.341-5.658c0-2.21.766-4.239 2.05-5.658');

                svg.appendChild(path);
                btn.appendChild(svg);

                // Add text safely using textContent
                btn.appendChild(document.createTextNode(`Generating ${format.toUpperCase()}...`));

                // Request the report from the API
                const response = await fetch(`${API_BASE_URL}/api/critique/download/${currentSessionId}?format=${format}`);

                if (!response.ok) {
                    const err = await response.json().catch(() => ({ detail: `HTTP ${response.status}: ${response.statusText}` }));
                    throw new Error(err.detail || 'Failed to download report');
                }

                // Download the blob from backend
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `PACT-${currentSessionId}.${format === "pdf" ? "pdf" : "md"}`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);

                // Show success notification
                showNotification(`${format.toUpperCase()} report downloaded successfully!`, 'success');

            } catch (error) {
                console.error('Download error:', error);
                showNotification(`Failed to download ${format.toUpperCase()} report. Please try again.`, 'error');
            } finally {
                // Restore the specific button that was clicked
                setTimeout(() => {
                    const btn = event.currentTarget;
                    if (btn) {
                        btn.innerHTML = btn.dataset.original || 'Download';
                        btn.disabled = false;
                        delete btn.dataset.original;
                    }
                }, 1000);
            }
        }

        // Display temporary notifications to the user
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-100 border border-green-400 text-green-700' :
                type === 'error' ? 'bg-red-100 border border-red-400 text-red-700' :
                'bg-blue-100 border border-blue-400 text-blue-700'
            }`;

            notification.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        ${type === 'success' ? 
                            '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>' :
                            type === 'error' ?
                            '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>' :
                            '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>'
                        }
                    </svg>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-lg font-bold hover:opacity-70">×</button>
                </div>
            `;

            document.body.appendChild(notification);

            // Automatically remove the notification after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Generate a markdown report from analysis data
        function generateReport(data) {
            return `# PACT Academic Critique Report

## Overall Assessment
- **Score:** ${data.overallScore}/100
- **Recommendation:** ${data.recommendation}

## Executive Summary
${data.summary}

## Key Strengths
${data.strengths.map(s => `- ${s}`).join('\n')}

## Priority Improvements
${data.improvements.map(i => `- ${i}`).join('\n')}

## Dimension Scores
${Object.entries(data.dimensions).map(([dim, score]) => `- ${dim}: ${score}/100`).join('\n')}

## Actionable Next Steps
${data.nextSteps.map((step, i) => `${i + 1}. ${step}`).join('\n')}

---
*Generated by PACT 3.0*`;
        }

        // Reset the UI and state to start a new analysis
        function startNewAnalysis() {
            // Close any active WebSocket connection
            if (websocket) {
                websocket.close();
                websocket = null;
            }

            // Reset session ID
            currentSessionId = null;

            // Reset UI sections
            document.getElementById('progress-section').classList.remove('hidden');
            document.getElementById('results-section').classList.add('hidden');

            // Reset progress bar and status message
            setProgress(0);
            updateStatus('Waiting to start...');

            // Reset agent card statuses
            document.querySelectorAll('.agent-card').forEach(card => {
                card.classList.remove('active');
                card.querySelector('.agent-status').textContent = 'Waiting';
                card.querySelector('.agent-status').className = 'agent-status text-xs text-gray-500';
                card.querySelector('.agent-message').classList.add('hidden');
            });

            // Navigate back to the upload screen
            showScreen('upload');

            // Clear the input form
            document.getElementById('paper-content').value = '';
            clearFile(); // Use the new clearFile function
            updateWordCount(); // Update word count display to 0

            // Reset the file drop zone UI to its initial state
            const uploadArea = document.getElementById('upload-area');
            uploadArea.style.display = 'block';
            const fileInfo = document.getElementById('file-info');
            fileInfo.classList.add('hidden');
            document.getElementById('file-name').textContent = ''; // Clear file name
        }

        // ===== FILE UPLOAD FUNCTIONS =====

        let uploadedFileContent = null;

        // Drag and drop handlers
        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            const uploadArea = document.getElementById('upload-area');
            uploadArea.style.backgroundColor = '#f0f9ff';
            uploadArea.style.borderColor = '#3b82f6';
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            const uploadArea = document.getElementById('upload-area');
            uploadArea.style.backgroundColor = '';
            uploadArea.style.borderColor = '';
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            const uploadArea = document.getElementById('upload-area');
            uploadArea.style.backgroundColor = '';
            uploadArea.style.borderColor = '';

            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const fileInput = document.getElementById('file-upload');
                fileInput.files = files;
                handleFileUpload({ target: fileInput });
            }
        }

        function triggerFileUpload() {
            document.getElementById('file-upload').click();
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            const validTypes = ['text/plain', 'application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            const validExtensions = ['.txt', '.pdf', '.docx'];
            const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));

            if (!validTypes.includes(file.type) && !validExtensions.includes(fileExtension)) {
                showMessage('Please upload a TXT, PDF, or DOCX file.', 'error');
                clearFile();
                return;
            }

            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                showMessage('File size must be less than 10MB.', 'error');
                clearFile();
                return;
            }

            const fileInfo = document.getElementById('file-info');
            const fileName = document.getElementById('file-name');
            const uploadArea = document.getElementById('upload-area');

            fileName.textContent = `Processing ${file.name}...`;
            fileInfo.classList.remove('hidden');
            uploadArea.style.display = 'none';

            try {
                // Upload file to backend for processing
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${API_BASE_URL}/api/upload`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({ detail: `HTTP ${response.status}: ${response.statusText}` }));
                    throw new Error(error.detail || 'Failed to process file');
                }

                const result = await response.json();
                uploadedFileContent = result.content;
                fileName.textContent = file.name;

                // Also populate the textarea with the content
                document.getElementById('paper-content').value = result.content;

                showMessage(`File "${file.name}" processed successfully!`, 'success');
                enableAnalysisButton();
                updateWordCount();

            } catch (error) {
                console.error('File upload error:', error);
                showMessage(`Error processing file: ${error.message}`, 'error');
                clearFile();
            }
        }

        function clearFile() {
            uploadedFileContent = null;
            document.getElementById('file-upload').value = '';
            document.getElementById('file-info').classList.add('hidden');
            document.getElementById('upload-area').style.display = 'block';
            // showMessage('File removed', 'info'); // Removed to avoid redundant messages
            updateWordCount(); // Update word count after clearing file
        }

        function updateWordCount() {
            const content = document.getElementById('paper-content').value || '';
            const wordCount = content.trim() ? content.trim().split(/\s+/).length : 0;
            document.getElementById('word-count').textContent = wordCount;
        }

        function enableAnalysisButton() {
            const button = document.getElementById('analyze-btn');
            button.disabled = false;
        }

        function showMessage(message, type = 'info') {
            showNotification(message, type);
        }

        // ===== ANALYSIS CONTROL FUNCTIONS =====

        // Start the PACT analysis process
        async function startAnalysis() {
            try {
                // Get paper content from either file upload or text area
                const paperContent = uploadedFileContent || document.getElementById('paper-content').value.trim();

                if (!paperContent) {
                    showMessage('Please upload a file or paste your paper content before starting analysis.', 'error');
                    return;
                }

                // Check minimum word count
                const wordCount = paperContent.trim().split(/\s+/).length;
                if (wordCount < 100) {
                    showMessage('Paper content is too short. Please provide at least 100 words for meaningful analysis.', 'error');
                    return;
                }

                // Get form values
                const paperType = document.getElementById('paper-type').value;
                const analysisMode = document.getElementById('analysisMode').value;
                const title = extractTitleFromContent(paperContent) || 'Untitled Paper';

                // Switch to analysis screen
                showScreen('analysis');

                // Reset progress and status
                setProgress(1);
                updateStatus('Initializing analysis...');

                // Clear any existing results
                currentResult = null;

                // Start the analysis
                const response = await fetch(`${API_BASE_URL}/api/critique/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title: title,
                        paper_content: paperContent,
                        mode: analysisMode,
                        paper_type: paperType
                    })
                });

                if (!response.ok) {
                    const error = await response.json().catch(() => ({ detail: `HTTP ${response.status}: ${response.statusText}` }));
                    throw new Error(error.detail || 'Failed to start analysis');
                }

                const data = await response.json();
                // Ensure we get the session ID as a string
                currentSessionId = typeof data.session_id === 'string' ? data.session_id : data.session_id.session_id || String(data.session_id);
                console.log('Using session ID:', currentSessionId);
                connectWebSocket(currentSessionId);

                showMessage('Analysis started successfully!', 'success');

            } catch (error) {
                console.error('Analysis start error:', error);
                showMessage(`Failed to start analysis: ${error.message}`, 'error');
                showScreen('upload');
            }
        }

        // Extract title from paper content
        function extractTitleFromContent(content) {
            const lines = content.split('\n').filter(line => line.trim().length > 0);
            if (lines.length > 0) {
                const firstLine = lines[0].trim();
                // Limit title length
                return firstLine.length > 100 ? firstLine.substring(0, 100) + '...' : firstLine;
            }
            return 'Untitled Paper';
        }

        // Connect to WebSocket for real-time updates
        function connectWebSocket(sessionId) {
            if (websocket) {
                websocket.close();
            }

            // Ensure sessionId is a string, not an object
            const cleanSessionId = typeof sessionId === 'string' ? sessionId : sessionId.session_id || String(sessionId);
            
            // Use wss:// for HTTPS and ws:// for HTTP
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/api/critique/live/${cleanSessionId}`;
            
            console.log('Attempting WebSocket connection to:', wsUrl);
            console.log('Session ID:', cleanSessionId);
            console.log('Current protocol:', window.location.protocol);
            
            try {
                websocket = new WebSocket(wsUrl);

                websocket.onopen = function() {
                    console.log('WebSocket connected successfully');
                    updateStatus('Connected to analysis service...');
                };

                websocket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('WebSocket message received:', data);
                        handleWebSocketMessage(data);
                    } catch (error) {
                        console.error('Error parsing WebSocket message:', error);
                    }
                };

                websocket.onclose = function(event) {
                    console.log('WebSocket disconnected - Code:', event.code, 'Reason:', event.reason);
                    updateStatus('Connection lost, switching to polling...');
                    // Start polling as fallback if not completed
                    if (currentSessionId && !currentResult) {
                        console.log('Starting polling fallback');
                        setTimeout(() => startPolling(currentSessionId), 1000);
                    }
                };

                websocket.onerror = function(error) {
                    console.error('WebSocket error occurred:', error);
                    console.log('WebSocket state:', websocket ? websocket.readyState : 'null');
                    updateStatus('Connection error, switching to polling...');
                    // Start polling as fallback immediately
                    if (currentSessionId) {
                        console.log('WebSocket failed, starting polling fallback');
                        setTimeout(() => startPolling(currentSessionId), 1000);
                    }
                };

            } catch (error) {
                console.error('Failed to create WebSocket:', error);
                updateStatus('WebSocket unavailable, using polling...');
                if (currentSessionId) {
                    setTimeout(() => startPolling(currentSessionId), 1000);
                }
            }
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            console.log('WebSocket message:', data);

            switch (data.event) {
                case 'status':
                    handleStatusUpdate(data);
                    break;
                case 'agent_start':
                    handleAgentStart(data);
                    break;
                case 'agent_complete':
                    handleAgentComplete(data);
                    break;
                case 'summary':
                    handleSummaryReceived(data);
                    break;
                case 'error':
                    handleAnalysisError(data);
                    break;
                default:
                    console.log('Unknown WebSocket event:', data.event);
            }
        }

        // Start polling as WebSocket fallback
        function startPolling(sessionId) {
            if (pollAbort) {
                pollAbort.abort();
            }

            pollAbort = new AbortController();
            pollResults(sessionId);
        }

        // Poll for results
        async function pollResults(sessionId) {
            if (currentResult) return; // Already have results

            console.log('Polling status for session:', sessionId);

            try {
                const response = await fetch(`${API_BASE_URL}/api/critique/status/${sessionId}`, {
                    signal: pollAbort.signal
                });

                console.log('Poll response status:', response.status);

                if (response.ok) {
                    const status = await response.json();
                    console.log('Poll response data:', status);

                    // Update progress
                    setProgress(status.progress || 0);
                    updateStatus(status.status === 'completed' ? 'Analysis completed!' : 'Analysis in progress...');

                    if (status.status === 'completed' && status.has_result) {
                        console.log('Analysis completed, fetching results...');
                        
                        // Get final results
                        const resultsResponse = await fetch(`${API_BASE_URL}/api/critique/results/${sessionId}`, {
                            signal: pollAbort.signal
                        });

                        if (resultsResponse.ok) {
                            const results = await resultsResponse.json();
                            console.log('Results fetched successfully:', results);
                            currentResult = results;
                            processAnalysisResults(results);
                            return;
                        } else {
                            console.error('Failed to fetch results:', resultsResponse.status);
                        }
                    } else if (status.status === 'error') {
                        console.error('Analysis failed:', status.error_message || 'Unknown error');
                        showMessage(`Analysis failed: ${status.error_message || 'Unknown error'}`, 'error');
                        return;
                    }
                } else if (response.status === 409) {
                    // Analysis not ready yet, continue polling
                    console.log('Analysis not ready yet, continuing polling...');
                } else if (response.status === 404) {
                    console.error('Session not found:', sessionId);
                    showMessage('Session not found. Please start a new analysis.', 'error');
                    return;
                } else {
                    console.error('Polling error status:', response.status);
                    const errorText = await response.text().catch(() => 'Unknown error');
                    console.error('Polling error response:', errorText);
                }

                // Continue polling if not completed
                if (!currentResult) {
                    currentPollTimeout = setTimeout(() => pollResults(sessionId), 2000);
                }

            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Polling error:', error);
                    // Retry polling after delay
                    currentPollTimeout = setTimeout(() => pollResults(sessionId), 5000);
                }
            }
        }

        // Handle status updates
        function handleStatusUpdate(data) {
            setProgress(data.progress || 0);
            updateStatus(data.message || data.status || 'Processing...');

            if (data.status === 'completed') {
                setProgress(100);
                updateStatus('Analysis completed successfully!');
            } else if (data.status === 'error') {
                handleAnalysisError(data);
            }
        }

        // Handle agent start events
        function handleAgentStart(data) {
            const agentId = data.agent || data.agent_id;
            updateAgentStatus(agentId, 'active', 'Analyzing...');
        }

        // Handle agent completion events
        function handleAgentComplete(data) {
            const agentId = data.agent || data.agent_id;
            updateAgentStatus(agentId, 'completed', 'Completed');
        }

        // Handle summary/results received
        function handleSummaryReceived(data) {
            if (data.payload) {
                currentResult = data.payload;
                processAnalysisResults(data.payload);
            }
        }

        // Handle analysis errors
        function handleAnalysisError(data) {
            const message = data.message || data.error || 'Analysis failed';
            console.error('Analysis error:', message);
            showMessage(`Analysis error: ${message}`, 'error');

            // Reset UI state
            setProgress(0);
            updateStatus('Analysis failed');

            // Show option to return to upload
            setTimeout(() => {
                if (confirm('Analysis failed. Would you like to try again?')) {
                    startNewAnalysis();
                }
            }, 2000);
        }

        // Process final analysis results
        function processAnalysisResults(results) {
            console.log('Processing analysis results:', results);

            // Store the results globally
            analysisData = results;

            // Show results section
            showResults();

            // Display the results in the UI with enhancements
            displayResultsEnhanced(results);

            // Clean up polling/websocket
            if (pollAbort) {
                pollAbort.abort();
                pollAbort = null;
            }
            if (currentPollTimeout) {
                clearTimeout(currentPollTimeout);
                currentPollTimeout = null;
            }
            if (websocket) {
                websocket.close();
                websocket = null;
            }
        }

        // Set progress percentage
        function setProgress(percent) {
            updateProgress(percent);
        }

        // Update status message
        function updateStatus(message) {
            document.getElementById('status-message').textContent = message;
        }

        // Update agent status
        function updateAgentStatus(agentId, status, message) {
            const agentCard = document.getElementById(`agent-${agentId}`);
            if (!agentCard) return;

            const statusElement = agentCard.querySelector('.agent-status');
            const messageElement = agentCard.querySelector('.agent-message');

            // Update status text and styling
            switch (status) {
                case 'active':
                    agentCard.classList.add('active', 'pulse-animation');
                    statusElement.textContent = 'Active';
                    statusElement.className = 'agent-status text-xs text-blue-600 font-medium';
                    messageElement.classList.remove('hidden');
                    messageElement.innerHTML = `
                        <div class="typing-indicator">
                            <span class="typing-dot"></span>
                            <span class="typing-dot"></span>
                            <span class="typing-dot"></span>
                        </div>
                    `;
                    break;
                case 'completed':
                    agentCard.classList.remove('pulse-animation');
                    agentCard.classList.add('active');
                    statusElement.textContent = 'Completed';
                    statusElement.className = 'agent-status text-xs text-green-600 font-medium';
                    messageElement.classList.add('hidden');
                    break;
                case 'waiting':
                default:
                    agentCard.classList.remove('active', 'pulse-animation');
                    statusElement.textContent = 'Waiting';
                    statusElement.className = 'agent-status text-xs text-gray-500';
                    messageElement.classList.add('hidden');
                    break;
            }
        }

        // Get default dimensions for fallback
        function getDefaultDimensions() {
            return {
                'Research Foundations': 3.5,
                'Methodological Rigor': 3.0,
                'Structure & Coherence': 4.0,
                'Academic Precision': 3.2,
                'Critical Sophistication': 3.8
            };
        }

        // ===== NAVIGATION FUNCTIONS =====

        // Show different screens
        function showScreen(screenName) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });

            // Show the selected screen
            document.getElementById(`${screenName}-screen`).classList.remove('hidden');

            // Update navigation state
            currentScreen = screenName;

            // Update navigation buttons
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('text-white', 'font-bold');
                btn.classList.add('opacity-80');
            });
        }

        // ===== COMPREHENSIVE INTERFACE FUNCTIONS =====

        function populateDimensionScores(dimensions) {
            const dimensionsList = document.getElementById('dimension-scores-list');
            const dimensionEntries = Object.entries(dimensions);

            dimensionsList.innerHTML = dimensionEntries.map(([dimensionName, score]) => {
                const normalizedScore = score > 5 ? score / 20 : score;
                const percentage = (normalizedScore / 5) * 100;
                const scoreLevel = getScoreLevel(normalizedScore);
                const scoreColor = getScoreBackground(normalizedScore);

                return `
                    <div class="space-y-1">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-900">${dimensionName}</span>
                            <span class="text-xs font-medium text-gray-600">${scoreLevel}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="h-2.5 rounded-full transition-all duration-500 ${scoreColor}" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getScoreLevel(score) {
            if (score >= 4.5) return "Exemplary";
            if (score >= 3.5) return "Strong";
            if (score >= 2.5) return "Competent";
            if (score >= 1.5) return "Developing";
            return "Inadequate";
        }

        function getScoreBackground(score) {
            if (score >= 4.5) return "bg-green-600";
            if (score >= 3.5) return "bg-green-500";
            if (score >= 2.5) return "bg-yellow-500";
            if (score >= 1.5) return "bg-orange-500";
            return "bg-red-500";
        }

        function populateKeyFindingsCards(data) {
            // Calculate counts from the analysis data
            const criticalCount = countCriticalIssues(data);
            const improvementCount = countImprovements(data);
            const strengthCount = countStrengths(data);

            document.getElementById('critical-count').textContent = criticalCount;
            document.getElementById('improvement-count').textContent = improvementCount;
            document.getElementById('strength-count').textContent = strengthCount;
        }

        function countCriticalIssues(data) {
            const dimensions = data.dimensionAnalyses || data.dimension_critiques || {};
            return Object.values(dimensions).reduce((count, dim) => {
                if (dim.dimension_score && dim.dimension_score < 40) count++; // Score < 40/100
                return count;
            }, 0);
        }

        function countImprovements(data) {
            const dimensions = data.dimensionAnalyses || data.dimension_critiques || {};
            const dimensionImprovements = Object.values(dimensions).reduce((count, dim) => {
                if (dim.dimension_score && dim.dimension_score >= 40 && dim.dimension_score < 80) count++;
                return count;
            }, 0);
            return dimensionImprovements || (data.improvements ? data.improvements.length : 0);
        }

        function countStrengths(data) {
            const dimensions = data.dimensionAnalyses || data.dimension_critiques || {};
            const dimensionStrengths = Object.values(dimensions).reduce((count, dim) => {
                if (dim.dimension_score && dim.dimension_score >= 80) count++;
                return count;
            }, 0);
            return dimensionStrengths || (data.strengths ? data.strengths.length : 0);
        }

        function populateDetailedFindings(data) {
            // Update counts in dropdown header
            const criticalCount = countCriticalIssues(data);
            const improvementCount = countImprovements(data);
            const strengthCount = countStrengths(data);

            document.getElementById('critical-issues-count').textContent = criticalCount;
            document.getElementById('improvement-issues-count').textContent = improvementCount;
            document.getElementById('strength-elements-count').textContent = strengthCount;

            // Populate critical issues list
            const criticalIssuesList = document.getElementById('critical-issues-list');
            const criticalIssues = getCriticalIssuesFromData(data);
            criticalIssuesList.innerHTML = criticalIssues.length > 0 ? criticalIssues.map(issue => `
                <div class="flex items-start space-x-2 p-2 bg-red-50 rounded border-l-2 border-red-600">
                    <svg class="h-4 w-4 text-red-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    <div class="min-w-0">
                        <p class="text-sm font-medium text-red-600">${issue.name}</p>
                        <p class="text-xs text-gray-600 mt-1">${issue.description}</p>
                    </div>
                </div>
            `).join('') : '<p class="text-sm text-gray-500 italic">No critical issues identified.</p>';

            // Populate improvement issues list
            const improvementIssuesList = document.getElementById('improvement-issues-list');
            const improvementIssues = getImprovementIssuesFromData(data);
            improvementIssuesList.innerHTML = improvementIssues.length > 0 ? improvementIssues.map(issue => `
                <div class="flex items-start space-x-2 p-2 bg-orange-50 rounded border-l-2 border-orange-500">
                    <svg class="h-4 w-4 text-orange-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    <div class="min-w-0">
                        <p class="text-sm font-medium text-orange-600">${issue.name}</p>
                        <p class="text-xs text-gray-600 mt-1">${issue.description}</p>
                    </div>
                </div>
            `).join('') : '<p class="text-sm text-gray-500 italic">No areas for improvement identified.</p>';

            // Populate strength elements list
            const strengthElementsList = document.getElementById('strength-elements-list');
            const strengthElements = getStrengthElementsFromData(data);
            strengthElementsList.innerHTML = strengthElements.length > 0 ? strengthElements.map(element => `
                <div class="flex items-start space-x-2 p-2 bg-green-50 rounded border-l-2 border-green-600">
                    <svg class="h-4 w-4 text-green-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <div class="min-w-0">
                        <p class="text-sm font-medium text-green-600">${element.name}</p>
                        <p class="text-xs text-gray-600 mt-1">${element.description}</p>
                    </div>
                </div>
            `).join('') : '<p class="text-sm text-gray-500 italic">No key strengths identified yet.</p>';
        }

        function getCriticalIssuesFromData(data) {
            const issues = [];
            const dimensions = data.dimensionAnalyses || data.dimension_critiques || {};
            Object.values(dimensions).forEach(dim => {
                if (dim.dimension_score && dim.dimension_score < 40) {
                    issues.push({
                        name: dim.dimension_name,
                        description: dim.weaknesses?.[0] || dim.priority_improvements?.[0]?.recommendation || 'Requires significant improvement'
                    });
                }
            });
            return issues;
        }

        function getImprovementIssuesFromData(data) {
            const issues = [];
            const dimensions = data.dimensionAnalyses || data.dimension_critiques || {};
            Object.values(dimensions).forEach(dim => {
                if (dim.dimension_score && dim.dimension_score >= 40 && dim.dimension_score < 80) {
                    issues.push({
                        name: dim.dimension_name,
                        description: dim.weaknesses?.[0] || dim.priority_improvements?.[0]?.recommendation || 'Could be strengthened'
                    });
                }
            });
            return issues;
        }

        function getStrengthElementsFromData(data) {
            const elements = [];
            const dimensions = data.dimensionAnalyses || data.dimension_critiques || {};
            Object.values(dimensions).forEach(dim => {
                if (dim.dimension_score && dim.dimension_score >= 80) {
                    elements.push({
                        name: dim.dimension_name,
                        description: dim.strengths?.[0] || dim.key_strengths?.[0]?.strength || 'Well-executed dimension'
                    });
                }
            });
            // Also add general strengths
            if (data.strengths && data.strengths.length > 0) {
                data.strengths.forEach(strength => {
                    elements.push({
                        name: 'General Strength',
                        description: strength
                    });
                });
            }
            return elements;
        }

        function populateDocumentContext(data) {
            const contextSection = document.getElementById('document-context');
            const documentType = document.getElementById('document-type');
            const contextGrid = document.getElementById('document-context-grid');

            // Show document context section
            contextSection.classList.remove('hidden');

            // Set document type
            const paperType = document.getElementById('paper-type').value;
            documentType.textContent = paperType.charAt(0).toUpperCase() + paperType.slice(1);

            // Populate context grid
            const wordCount = document.getElementById('word-count').textContent;
            const analysisMode = document.getElementById('analysisMode').value;

            contextGrid.innerHTML = `
                <div>
                    <span class="font-medium text-purple-600">Word Count:</span>
                    <span class="text-gray-700">${wordCount} words</span>
                </div>
                <div>
                    <span class="font-medium text-purple-600">Analysis Mode:</span>
                    <span class="text-gray-700">${analysisMode}</span>
                </div>
                <div>
                    <span class="font-medium text-purple-600">Date Analyzed:</span>
                    <span class="text-gray-700">${new Date().toLocaleDateString()}</span>
                </div>
            `;
        }

        function populateAnalysisMetadata(data) {
            const metadataSection = document.getElementById('analysis-metadata');
            const coveragePercentage = document.getElementById('coverage-percentage');
            const metadataGrid = document.getElementById('analysis-metadata-grid');

            // Show metadata section
            metadataSection.classList.remove('hidden');

            // Calculate coverage percentage (mock calculation)
            const dimensionCount = Object.keys(data.dimensions || {}).length;
            const maxDimensions = 5;
            const coverage = Math.round((dimensionCount / maxDimensions) * 100);

            coveragePercentage.textContent = `${coverage}% Coverage`;

            // Populate metadata grid
            metadataGrid.innerHTML = `
                <div>
                    <span class="font-medium text-blue-600">Dimensions Analyzed:</span>
                    <span class="text-gray-700">${dimensionCount} of ${maxDimensions}</span>
                </div>
                <div>
                    <span class="font-medium text-blue-600">Elements Evaluated:</span>
                    <span class="text-gray-700">${(dimensionCount * 3) || 15}</span>
                </div>
                <div>
                    <span class="font-medium text-blue-600">Analysis Depth:</span>
                    <span class="text-gray-700">Comprehensive</span>
                </div>
                <div>
                    <span class="font-medium text-blue-600">Quality Checks:</span>
                    <span class="text-gray-700">Passed</span>
                </div>
            `;
        }

        function populateMainTabContent(data) {
            // Summary Analysis tab
            const summaryContent = document.getElementById('summary-analysis-content');
            const summaryText = data.summary || data.executive_summary || 
                               'Your paper has been comprehensively analyzed using the PACT Academic Critique Taxonomy. The analysis covers multiple dimensions of academic writing quality, from research foundations to critical sophistication. Review the detailed feedback in each dimension to understand your paper\'s strengths and areas for improvement.';

            summaryContent.innerHTML = `
                <div class="text-left space-y-6">
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6">
                        <h4 class="text-xl font-semibold mb-4 text-blue-800">Executive Summary</h4>
                        <div class="prose max-w-none">
                            <p class="text-gray-700 leading-relaxed">${summaryText}</p>
                        </div>
                        ${!data.qualitativeMode && data.submissionReadiness ? `
                            <div class="mt-4 p-3 bg-blue-100 rounded-lg">
                                <span class="text-sm font-medium text-blue-800">Submission Readiness: ${data.submissionReadiness}</span>
                            </div>
                        ` : ''}
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h5 class="font-semibold text-green-800 mb-3">Key Strengths</h5>
                            <ul class="space-y-2">
                                ${(data.strengths || ['Analysis completed successfully', 'Paper structure is coherent', 'Research topic is well-defined']).slice(0, 3).map(strength => 
                                    `<li class="flex items-start space-x-2">
                                        <svg class="h-4 w-4 text-green-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        <span class="text-sm text-green-700">${strength}</span>
                                    </li>`
                                ).join('')}
                            </ul>
                        </div>

                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                            <h5 class="font-semibold text-orange-800 mb-3">Priority Improvements</h5>
                            <ul class="space-y-2">
                                ${(data.improvements || ['Consider strengthening methodology section', 'Review citation formatting', 'Expand theoretical framework']).slice(0, 3).map(improvement => 
                                    `<li class="flex items-start space-x-2">
                                        <svg class="h-4 w-4 text-orange-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                        </svg>
                                        <span class="text-sm text-orange-700">${improvement}</span>
                                    </li>`
                                ).join('')}
                            </ul>
                        </div>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h5 class="font-semibold text-blue-800 mb-3">Next Steps</h5>
                        <ol class="space-y-2">
                            ${(data.nextSteps || ['Review detailed feedback in each dimension', 'Address priority improvements first', 'Consider revision timeline', 'Seek additional feedback if needed']).slice(0, 4).map((step, index) => 
                                `<li class="flex items-start space-x-3">
                                    <span class="inline-flex items-center justify-center h-6 w-6 rounded-full bg-blue-600 text-white text-xs font-medium">${index + 1}</span>
                                    <span class="text-sm text-blue-700">${step}</span>
                                </li>`
                            ).join('')}
                        </ol>
                    </div>
                </div>
            `;

            // PACT Details tab - populate dimension tabs
            populateDimensionTabs(data.dimensionAnalyses || {});

            // Custom Analysis tab (if available)
            if (data.customAnalysis) {
                document.getElementById('main-tab-custom').classList.remove('hidden');
                populateCustomAnalysisTab(data.customAnalysis);
            }
        }

        function populateDimensionTabs(dimensionAnalyses) {
            const dimensionTabsNav = document.getElementById('dimension-tabs');
            const dimensionTabContent = document.getElementById('dimension-tab-content');

            // For qualitative mode, use the dimensions array
            const dimensions = analysisData && analysisData.qualitativeMode ? 
                analysisData.dimensions : Object.entries(dimensionAnalyses);

            // If no dimension data, create default structure
            if (dimensions.length === 0) {
                const defaultDimensions = [
                    { id: '1.0.0', name: 'Research Foundations', overall_assessment: 'Competent', summary: 'Analysis of research question, literature review, and theoretical framework.' },
                    { id: '2.0.0', name: 'Methodological Rigor', overall_assessment: 'Competent', summary: 'Evaluation of research methods, data collection, and analysis procedures.' },
                    { id: '3.0.0', name: 'Structure & Coherence', overall_assessment: 'Competent', summary: 'Assessment of organization, flow, and logical progression.' },
                    { id: '4.0.0', name: 'Academic Precision', overall_assessment: 'Competent', summary: 'Review of citations, terminology, grammar, and formatting.' },
                    { id: '5.0.0', name: 'Critical Sophistication', overall_assessment: 'Competent', summary: 'Analysis of critical thinking, originality, and scholarly depth.' }
                ];

                // Create navigation for default dimensions
                dimensionTabsNav.innerHTML = defaultDimensions.map((dim, index) => `
                    <button onclick="showDimensionTab('${dim.id}')" id="dim-tab-${dim.id}" class="dim-tab-btn py-2 px-1 border-b-2 font-medium text-xs ${index === 0 ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}">
                        ${dim.name.split(' ')[0]}
                    </button>
                `).join('');

                // Create content for default dimensions in qualitative mode
                dimensionTabContent.innerHTML = defaultDimensions.map((dim, index) => `
                    <div id="dim-content-${dim.id}" class="dim-tab-content ${index !== 0 ? 'hidden' : ''}">
                        <div class="space-y-4">
                            <div class="mb-4">
                                <h3 class="text-lg font-semibold text-gray-900 mb-2">${dim.name}</h3>
                                <p class="text-sm text-gray-600 mb-4">${dim.summary}</p>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-4">
                                        <div class="px-3 py-1 rounded-full bg-blue-500 text-white text-sm font-medium">
                                            ${dim.overall_assessment}
                                        </div>
                                    </div>
                                    <button onclick="window.open('/pact-wiki/dimensions/${dim.id}', '_blank')" class="inline-flex items-center px-3 py-1 text-sm border border-blue-600 rounded text-blue-600 hover:bg-blue-600 hover:text-white transition-colors">
                                        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                        </svg>
                                        Learn About This Dimension
                                    </button>
                                </div>
                            </div>

                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div class="flex items-center space-x-2 mb-3">
                                    <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <h4 class="font-semibold text-blue-800">Analysis Complete</h4>
                                </div>
                                <p class="text-sm text-blue-700">
                                    Your paper has been analyzed for this dimension. The detailed feedback 
                                    will be available in the comprehensive PDF report. Click "Export PDF" above to download your complete analysis.
                                </p>
                            </div>
                        </div>
                    `).join('');
                return;
            }

            // Create dimension tabs navigation for qualitative data
            dimensionTabsNav.innerHTML = dimensions.map((dimension, index) => `
                <button onclick="showDimensionTab('${dimension.id}')" id="dim-tab-${dimension.id}" class="dim-tab-btn py-2 px-1 border-b-2 font-medium text-xs ${index === 0 ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}">
                    ${dimension.name.split(' ')[0]}
                </button>
            `).join('');

            // Create dimension tab content for qualitative data with per-issue cards
            dimensionTabContent.innerHTML = dimensions.map((dimension, index) => `
                <div id="dim-content-${dimension.id}" class="dim-tab-content ${index !== 0 ? 'hidden' : ''}">
                    <div class="space-y-4">
                        <div class="mb-4">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">${dimension.name}</h3>
                            <p class="text-sm text-gray-600 mb-4">${dimension.executive_summary || 'Analysis completed for this dimension.'}</p>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <div class="px-3 py-1 rounded-full ${getScoreBackground((dimension.dimension_score || 75) / 20)} text-white text-sm font-medium">
                                        ${((dimension.dimension_score || 75) / 20).toFixed(1)}/5
                                    </div>
                                    <span class="text-sm text-gray-600">${dimension.overall_assessment || 'Competent'}</span>
                                </div>
                                <button onclick="window.open('/pact-wiki/dimensions/${dimension.id}', '_blank')" class="inline-flex items-center px-3 py-1 text-sm border border-blue-600 rounded text-blue-600 hover:bg-blue-600 hover:text-white transition-colors">
                                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                    </svg>
                                    Learn About This Dimension
                                </button>
                            </div>
                        </div>

                        <!-- Subsections if available -->
                        ${dimension.subsections ? Object.entries(dimension.subsections).map(([code, subsection]) => `
                            <div class="bg-gray-50 rounded-lg p-4 border-l-4 border-blue-500">
                                <h4 class="font-semibold text-gray-900 mb-2">${code}: ${subsection.name}</h4>
                                <div class="mb-2">
                                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium ${
                                        subsection.assessment === 'Strong' ? 'bg-green-100 text-green-700' :
                                        subsection.assessment === 'Developing' ? 'bg-yellow-100 text-yellow-700' :
                                        'bg-red-100 text-red-700'
                                    }">${subsection.assessment}</span>
                                </div>
                                <p class="text-sm text-gray-600 mb-3">${subsection.detailed_feedback}</p>

                                ${subsection.strengths && subsection.strengths.length > 0 ? `
                                    <div class="mb-2">
                                        <span class="text-xs font-medium text-green-700">Strengths:</span>
                                        <ul class="list-disc list-inside text-xs text-gray-600 ml-2 mt-1">
                                            ${subsection.strengths.map(s => `<li>${s}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}

                                ${subsection.areas_for_improvement && subsection.areas_for_improvement.length > 0 ? `
                                    <div>
                                        <span class="text-xs font-medium text-orange-700">Areas for Improvement:</span>
                                        <ul class="list-disc list-inside text-xs text-gray-600 ml-2 mt-1">
                                            ${subsection.areas_for_improvement.map(i => `<li>${i}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('') : `
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div class="flex items-center space-x-2 mb-3">
                                    <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <h4 class="font-semibold text-blue-800">Detailed Analysis Available</h4>
                                </div>
                                <p class="text-sm text-blue-700 mb-3">
                                    Comprehensive subsection-level feedback for this dimension is available in your PDF report.
                                </p>
                                <button onclick="downloadReport('comprehensive')" class="inline-flex items-center px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    Download Full Analysis
                                </button>
                            </div>
                        `}

                        ${dimension.key_strengths && dimension.key_strengths.length > 0 ? `
                            <div class="bg-green-50 rounded-lg p-4 border-l-4 border-green-500">
                                <h4 class="font-semibold text-green-700 mb-2">Key Dimension Strengths:</h4>
                                <ul class="space-y-1">
                                    ${dimension.key_strengths.map(s => `
                                        <li class="text-sm text-green-700">
                                            <strong>${s.strength}:</strong> ${s.evidence || 'Well executed in this area'}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}

                        ${dimension.priority_improvements && dimension.priority_improvements.length > 0 ? `
                            <div class="bg-orange-50 rounded-lg p-4 border-l-4 border-orange-500">
                                <h4 class="font-semibold text-orange-700 mb-2">Priority Improvements:</h4>
                                <ul class="space-y-1">
                                    ${dimension.priority_improvements.map(i => `
                                        <li class="text-sm text-orange-700">
                                            <strong>${i.area}:</strong> ${i.recommendation || 'Consider strengthening this aspect'}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function populateCustomAnalysisTab(customAnalysis) {
            const customContent = document.getElementById('custom-analysis-content');
            customContent.innerHTML = `
                <div class="space-y-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <div class="flex items-start space-x-3">
                            <div class="w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0"></div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-blue-800 mb-3">Your Custom Question</h3>
                                <p class="text-blue-700 bg-blue-100 rounded p-3 text-sm">${customAnalysis.question}</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Analysis Response</h4>
                        <div class="prose max-w-none">
                            <p class="text-gray-900 leading-relaxed whitespace-pre-wrap">${customAnalysis.response}</p>
                        </div>
                    </div>

                    ${customAnalysis.keyFindings && customAnalysis.keyFindings.length > 0 ? `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-green-800 mb-4">Key Findings</h4>
                            <ul class="space-y-2">
                                ${customAnalysis.keyFindings.map(finding => `
                                    <li class="flex items-start space-x-3">
                                        <div class="w-2 h-2 bg-green-500 rounded-full mt-2 flex-shrink-0"></div>
                                        <span class="text-green-700 text-sm">${finding}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    ${customAnalysis.recommendations && customAnalysis.recommendations.length > 0 ? `
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-orange-800 mb-4">Recommendations</h4>
                            <ul class="space-y-2">
                                ${customAnalysis.recommendations.map(recommendation => `
                                    <li class="flex items-start space-x-3">
                                        <div class="w-2 h-2 bg-orange-500 rounded-full mt-2 flex-shrink-0"></div>
                                        <span class="text-orange-700 text-sm">${recommendation}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function toggleDetailedFindings() {
            const detailedFindings = document.getElementById('detailed-findings');
            const chevron = document.getElementById('findings-chevron');

            detailedFindings.classList.toggle('hidden');
            chevron.classList.toggle('rotate-180');
        }

        function showMainTab(tabName) {
            // Hide all main tab content
            document.querySelectorAll('.main-tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });

            // Reset all main tab button styles
            document.querySelectorAll('.main-tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });

            // Show the selected main tab content
            document.getElementById(`main-tab-content-${tabName}`).classList.remove('hidden');

            // Highlight the selected main tab button
            const activeBtn = document.getElementById(`main-tab-${tabName}`);
            activeBtn.classList.remove('border-transparent', 'text-gray-500');
            activeBtn.classList.add('border-blue-500', 'text-blue-600');
        }

        function showDimensionTab(dimensionId) {
            // Hide all dimension tab content
            document.querySelectorAll('.dim-tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });

            // Reset all dimension tab button styles
            document.querySelectorAll('.dim-tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });

            // Show the selected dimension tab content
            document.getElementById(`dim-content-${dimensionId}`).classList.remove('hidden');

            // Highlight the selected dimension tab button
            const activeBtn = document.getElementById(`dim-tab-${dimensionId}`);
            activeBtn.classList.remove('border-transparent', 'text-gray-500');
            activeBtn.classList.add('border-blue-500', 'text-blue-600');
        }

        // Share functionality
        async function shareResults() {
            if (!currentSessionId) {
                alert('No analysis results available to share.');
                return;
            }

            try {
                const shareData = {
                    title: 'PACT Analysis Results',
                    text: 'Check out my comprehensive PACT academic paper analysis',
                    url: window.location.href + '?session=' + currentSessionId
                };

                if (navigator.share && navigator.canShare(shareData)) {
                    await navigator.share(shareData);
                } else {
                    // Fallback: copy to clipboard
                    await navigator.clipboard.writeText(shareData.url);
                    showNotification('Analysis link copied to clipboard!', 'success');
                }
            } catch (err) {
                console.error('Error sharing:', err);
                showNotification('Unable to share results. Please try again.', 'error');
            }
        }

        // Enhanced displayResults to include spider chart
        function displayResultsEnhanced(data) {
            // Call the original displayResults function
            displayResults(data);

            // Add spider chart if dimension data is available
            if (data.dimensions || data.dimension_critiques) {
                const dimensions = data.dimensions || Object.entries(data.dimension_critiques || {}).map(([id, critique]) => ({
                    id: id,
                    name: critique.dimension_name || `Dimension ${id}`,
                    score: critique.dimension_score || 0
                }));

                if (dimensions.length > 0) {
                    // Create spider chart
                    createDimensionChart(dimensions);
                }
            }
        }
    </script>
</body>
</html>